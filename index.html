<html>
  <head>
    <title>Kyousushi</title>	
	<script src="phonegap.js"></script>	
	<script src="cordova.js"></script>	
  </head>
  <body style="background:url('img/fond2.png') 0 0 no-repeat; background-size: 100% 100%;">
        <div class="app">
            <h1 style="text-align:center;"><img src="logo.png" /></h1>
            <div style="position:relative">
		<div id="page" style="margin-left:15%">			
			<div id="myDiv1" onClick = "redirectKyouThionville()" style=" border: solid 1px #996600; border-radius: 0.3em; height:28%; width:75%"></div>
		</div>
		<div id="page" style="margin-left:15%">
			<div id="myDiv2" onClick = "redirectKyouMetz()" style=" border: solid 1px #996600; border-radius: 0.3em; margin-top:8%; height:28%; width:75%"></div>
		</div>
		</div>
		<img src="img/facebook.png" onClick = "redirectKyouFB()" style="width: 10%; height:7%; float:right; margin-bottom:4%"/>
</div>

	<script type="text/javascript" src="PushNotification.js"></script>
    <script>
	
		function redirectKyouMetz() {	
         var ref = window.open('pageMetz.html', '_self', 'location=yes');
	}
	function redirectKyouThionville() {	
         var ref = window.open('pageThionville.html', '_self', 'location=yes');
	}
	function redirectKyouFB() {	
         var ref = window.open('https://www.facebook.com/KyouSushi', '_system', 'location=yes');
	}
	
    // Wait for device API libraries to load
		document.addEventListener("deviceready", onDeviceReady, false);
		document.addEventListener("deviceready", initPushwoosh, true);

    // device APIs are available
	var options = { timeout: 31000, enableHighAccuracy: true, maximumAge: 90000 };
    function onDeviceReady() {
        navigator.geolocation.getCurrentPosition(onSuccess, onError, options);
    }
	
    // onSuccess Geolocation
    function onSuccess(position) {
        var element1 = document.getElementById('myDiv1');
		var element2 = document.getElementById('myDiv2');
		
		var distTh = Distance(position.coords.latitude , position.coords.longitude, 49.3667, 6.1667);
		var distMe = Distance(position.coords.latitude , position.coords.longitude, 49.119327,  6.17101);
		
		if(parseFloat(distMe) > parseFloat(distTh)){
			element1.innerHTML = '<p style="text-align:center; margin-top:10%;color:e2b500">Vous êtes plus proche du </p>';
			element1.innerHTML += '<p style="text-align:center;">Restaurant de Thionville<br />Distance : ' + distTh + 'km <br /><br />Cliquer ici pour plus d\'information </p>';
			element2.innerHTML = '<p style="text-align:center; margin-top:15%;">Restaurant de Metz<br />Distance : ' + distMe + 'km <br /><br />Cliquer ici pour plus d\'information</p>';
			element1.style.backgroundColor = "white";
			element2.style.backgroundColor = "white";

			}else{ 
			element2.innerHTML = '<p style="text-align:center; margin-top:10%;color:e2b500">Vous êtes plus proche du '+ device.model+'</p>';
			element2.innerHTML += '<p style="text-align:center;">Restaurant de Metz<br />Distance : ' + distMe + 'km <br /><br />Cliquer ici pour plus d\'information</p>';				
			element1.innerHTML = '<p style="text-align:center; margin-top:15%">Restaurant de Thionville<br />Distance : ' + distTh + 'km <br /><br />Cliquer ici pour plus d\'information</p>';
			element1.style.backgroundColor = "white";
			element2.style.backgroundColor = "white";
 }
 }

    // onError Callback receives a PositionError object
    function onError(error) {
        alert('message: Les données du GPS doivent être accessibles pour que l\' application fonctionne correctement. Veuillez activer le GPS.\n');}
	
		var LatA = 41.3879169;
		var LngB = 2.1699187;

		var LatB = 40.4167413;
		var LngB = -3.7032498;

		Distancia = Dist(LatA, LngA, LatB, LngB);  

		function Distance(LatA, LngA, LatB, LngB)
		  {
		  rad = function(x) {return x*Math.PI/180;}

		  var R     = 6371;                         
		  var dLat  = rad( LatB - LatA );
		  var dLong = rad( LngB - LngA );

		  var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(rad(LatA)) * Math.cos(rad(LatB)) * Math.sin(dLong/2) * Math.sin(dLong/2);
		  var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
		  var d = R * c;

		  return d.toFixed(1);     
		}
		
	// pushwoosh
	if(device.platform == "Android") {
	function initPushwoosh(){
    var pushNotification = window.plugins.pushNotification;
    pushNotification.onDeviceReady();
 
    pushNotification.registerDevice({ projectid: "222157888865", appid : "C125D-81938" },
        function(status) {
            var pushToken = status;
            console.warn('push token: ' + pushToken);
        },
        function(status) {
            console.warn(JSON.stringify(['failed to register ', status]));
        }
    );
 
    document.addEventListener('push-notification', function(event) {
        var title = event.notification.title;
            var userData = event.notification.userdata;
                                 
            if(typeof(userData) != "undefined") {
            console.warn('user data: ' + JSON.stringify(userData));
        }
                                     
        navigator.notification.alert(title);
    });
		}
	} else {
	function initPushwoosh() {
    var pushNotification = window.plugins.pushNotification;
    pushNotification.onDeviceReady();
     
    pushNotification.registerDevice({alert:true, badge:true, sound:true, pw_appid:"C125D-81938", appname:"Kyou"},
        function(status) {
            var deviceToken = status['deviceToken'];
            console.warn('registerDevice: ' + deviceToken);
        },
        function(status) {
            console.warn('failed to register : ' + JSON.stringify(status));
            navigator.notification.alert(JSON.stringify(['failed to register ', status]));
        }
    );
     
    pushNotification.setApplicationIconBadgeNumber(0);
     
    document.addEventListener('push-notification', function(event) {
        var notification = event.notification;
        navigator.notification.alert(notification.aps.alert);
        pushNotification.setApplicationIconBadgeNumber(0);
    });
}
	}


			// Call this to register for push notifications and retreive a deviceToken
			PushNotification.prototype.registerDevice = function(config, success, fail) {
				cordova.exec(success, fail, "PushNotification", "registerDevice", config ? [config] : []);
			};
			 
			// Call this to set tags for the device
			PushNotification.prototype.setTags = function(config, success, fail) {
				cordova.exec(success, fail, "PushNotification", "setTags", config ? [config] : []);
			};
			 
			//Unregister device from push notifications
			PushNotification.prototype.unregisterDevice = function(success, fail) {
				cordova.exec(success, fail, "PushNotification", "unregisterDevice", []);
			};
			 
			//starts geo push notifications
			PushNotification.prototype.startGeoPushes = function(success, fail) {
				cordova.exec(success, fail, "PushNotification", "startGeoPushes", []);
			};
			 
			//stops geo push notifications
			PushNotification.prototype.stopGeoPushes = function(success, fail) {
				cordova.exec(success, fail, "PushNotification", "stopGeoPushes", []);
			};
			 
			//sets multi notification mode on
			PushNotification.prototype.setMultiNotificationMode = function(success, fail) {
				cordova.exec(success, fail, "PushNotification", "setMultiNotificationMode", []);
			};
			 
			//sets single notification mode
			PushNotification.prototype.setSingleNotificationMode = function(success, fail) {
				cordova.exec(success, fail, "PushNotification", "setSingleNotificationMode", []);
			};
			 
			//type: 0 default, 1 no sound, 2 always
			PushNotification.prototype.setSoundType = function(type, success, fail) {
				cordova.exec(success, fail, "PushNotification", "setSoundType", [type]);
			}; 
			 
			//type: 0 default, 1 no vibration, 2 always
			PushNotification.prototype.setVibrateType = function(type, success, fail) {
				cordova.exec(success, fail, "PushNotification", "setVibrateType", [type]);
			}; 
    </script>
  </body>
</html>